name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 1.0.1). No "v" prefix needed.'
        required: true
        type: string
      dry_run:
        description: 'Dry run — build and test but skip creating the GitHub Release'
        required: false
        type: boolean
        default: false

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:

  # ── Job 1: Validate version ─────────────────────────────────────────────────
  validate:
    name: Validate Version
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract and validate version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          TAG="v${VERSION}"

          # Validate semver format
          if [[ ! "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: '${VERSION}'. Expected semver (e.g. 1.0.1 or 1.0.1-beta.1)"
            exit 1
          fi

          # Verify input version matches gradle.properties
          GRADLE_VERSION=$(grep '^version=' gradle.properties | cut -d'=' -f2)
          if [[ "${VERSION}" != "${GRADLE_VERSION}" ]]; then
            echo "::warning::Input version '${VERSION}' does not match gradle.properties version '${GRADLE_VERSION}'"
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Version: ${VERSION}"
          echo "Tag: ${TAG}"

  # ── Job 2: Build native binaries (matrix) ───────────────────────────────────
  build-native:
    name: Build ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    needs: validate

    strategy:
      fail-fast: true
      matrix:
        include:
          - os: linux
            arch: x86_64
            runner: ubuntu-latest
            binary_name: flamingock
            artifact_suffix: ''
          - os: macos
            arch: arm64
            runner: macos-latest
            binary_name: flamingock
            artifact_suffix: ''
          - os: macos
            arch: x86_64
            runner: macos-13
            binary_name: flamingock
            artifact_suffix: ''
          - os: windows
            arch: x86_64
            runner: windows-latest
            binary_name: flamingock.exe
            artifact_suffix: '.exe'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup GraalVM 21
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm'
          cache: 'gradle'

      - name: Build & test
        run: ./gradlew build
        shell: bash

      - name: Compile native image
        run: ./gradlew nativeCompile
        shell: bash

      - name: Rename native binary
        shell: bash
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          SRC="build/native/nativeCompile/${{ matrix.binary_name }}"
          DEST="flamingock-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.artifact_suffix }}"
          cp "${SRC}" "${DEST}"
          echo "Renamed ${SRC} → ${DEST}"
          ls -lh "${DEST}"

      - name: Upload native binary
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.os }}-${{ matrix.arch }}
          path: flamingock-${{ needs.validate.outputs.version }}-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.artifact_suffix }}
          retention-days: 5
          if-no-files-found: error

      - name: Rename uber JAR
        if: matrix.os == 'linux'
        shell: bash
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          SRC=$(ls build/libs/flamingock-cli-*-uber.jar)
          DEST="flamingock-cli-${VERSION}.jar"
          cp "${SRC}" "${DEST}"
          echo "Renamed ${SRC} → ${DEST}"
          ls -lh "${DEST}"

      - name: Upload uber JAR
        if: matrix.os == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: uber-jar
          path: flamingock-cli-${{ needs.validate.outputs.version }}.jar
          retention-days: 5
          if-no-files-found: error

  # ── Job 3: Integration tests ────────────────────────────────────────────────
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [validate, build-native]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Download uber JAR
        uses: actions/download-artifact@v4
        with:
          name: uber-jar
          path: build/libs/

      - name: Download Linux native binary
        uses: actions/download-artifact@v4
        with:
          name: native-linux-x86_64

      - name: Make native binary executable
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          chmod +x "flamingock-${VERSION}-linux-x86_64"

      - name: Start MySQL
        run: docker compose -f integration-tests/docker-compose.yml up -d --wait

      - name: Run integration tests (uber JAR)
        run: ./integration-tests/run-tests.sh --no-docker --verbose

      - name: Run integration tests (native binary)
        run: ./integration-tests/run-tests.sh --no-docker --verbose
        env:
          CLI_CMD: ./flamingock-${{ needs.validate.outputs.version }}-linux-x86_64

      - name: Stop MySQL
        if: always()
        run: docker compose -f integration-tests/docker-compose.yml down -v

      - name: Download macOS arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: native-macos-arm64

      - name: Download macOS x86_64 binary
        uses: actions/download-artifact@v4
        with:
          name: native-macos-x86_64

      - name: Download Windows binary
        uses: actions/download-artifact@v4
        with:
          name: native-windows-x86_64

      - name: Smoke test artifacts
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          echo "=== Verifying artifact presence and structure ==="

          for artifact in \
            "flamingock-${VERSION}-linux-x86_64" \
            "flamingock-${VERSION}-macos-arm64" \
            "flamingock-${VERSION}-macos-x86_64" \
            "flamingock-${VERSION}-windows-x86_64.exe" \
            "build/libs/flamingock-cli-${VERSION}.jar"; do

            if [[ ! -f "${artifact}" ]]; then
              echo "::error::Missing artifact: ${artifact}"
              exit 1
            fi

            SIZE=$(stat --format=%s "${artifact}" 2>/dev/null || stat -f%z "${artifact}")
            if [[ "${SIZE}" -lt 1000 ]]; then
              echo "::error::Artifact too small (${SIZE} bytes): ${artifact}"
              exit 1
            fi

            FILE_TYPE=$(file "${artifact}")
            echo "  ✓ ${artifact} (${SIZE} bytes) — ${FILE_TYPE}"
          done

          # Verify binary formats using file command
          file "flamingock-${VERSION}-linux-x86_64" | grep -q "ELF" || { echo "::error::Linux binary is not ELF format"; exit 1; }
          file "flamingock-${VERSION}-macos-arm64" | grep -q "Mach-O" || { echo "::error::macOS arm64 binary is not Mach-O format"; exit 1; }
          file "flamingock-${VERSION}-macos-x86_64" | grep -q "Mach-O" || { echo "::error::macOS x86_64 binary is not Mach-O format"; exit 1; }
          file "flamingock-${VERSION}-windows-x86_64.exe" | grep -q "PE" || { echo "::error::Windows binary is not PE format"; exit 1; }

          echo ""
          echo "=== All artifacts verified ==="

  # ── Job 4: Create GitHub Release ────────────────────────────────────────────
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate, build-native, integration-test]
    if: ${{ !(github.event.inputs.dry_run == 'true') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all native binaries
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: release-assets
          merge-multiple: true

      - name: Download uber JAR
        uses: actions/download-artifact@v4
        with:
          name: uber-jar
          path: release-assets

      - name: Generate checksums
        working-directory: release-assets
        run: |
          sha256sum * | tee SHA256SUMS.txt
          echo ""
          echo "=== Release assets ==="
          ls -lh

      - name: Determine pre-release
        id: prerelease
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          if [[ "${VERSION}" == *-* ]]; then
            echo "flag=--prerelease" >> "$GITHUB_OUTPUT"
            echo "Pre-release detected: ${VERSION}"
          else
            echo "flag=" >> "$GITHUB_OUTPUT"
            echo "Stable release: ${VERSION}"
          fi

      - name: Create git tag
        run: |
          TAG="${{ needs.validate.outputs.tag }}"
          git tag "${TAG}"
          git push origin "${TAG}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          TAG="${{ needs.validate.outputs.tag }}"

          gh release create "${TAG}" \
            --title "Flamingock CLI v${VERSION}" \
            --generate-notes \
            ${{ steps.prerelease.outputs.flag }} \
            release-assets/*
